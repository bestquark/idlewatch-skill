name: CI

on:
  push:
  pull_request:

jobs:
  node-tests:
    name: Node ${{ matrix.node-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            node-version: 20
          - os: ubuntu-latest
            node-version: 22
          - os: macos-latest
            node-version: 22
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install
        run: npm install

      - name: Validate package bin entries
        run: npm run validate:bin

      - name: Lint (if present)
        run: npm run lint --if-present

      - name: Unit tests
        run: npm run test:unit

      - name: Smoke: CLI help
        run: npm run smoke:help

      - name: Smoke: dry run
        run: npm run smoke:dry-run

      - name: Validate dry-run telemetry schema
        run: npm run validate:dry-run-schema

      - name: Validate usage freshness long-window transitions
        run: npm run validate:usage-freshness-e2e

      - name: Validate usage alert-rate quality gate
        run: npm run validate:usage-alert-rate-e2e

      - name: Validate OpenClaw cache recovery from stale fallback
        run: npm run validate:openclaw-cache-recovery-e2e

      - name: Validate OpenClaw stats-ingestion fallback parse
        run: npm run validate:openclaw-stats-ingestion

  macos-packaging-smoke:
    name: macOS packaging scaffold smoke
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install
        run: npm install

      - name: Build macOS app scaffold
        run: npm run package:macos

      - name: Validate packaged metadata
        run: npm run validate:packaged-metadata

      - name: App scaffold dry-run
        run: ./dist/IdleWatch.app/Contents/MacOS/IdleWatch --dry-run

      - name: Validate packaged app dry-run telemetry schema
        run: npm run validate:packaged-dry-run-schema:reuse-artifact

      - name: Validate packaged bundled-runtime launcher path (no PATH node)
        run: npm run validate:packaged-bundled-runtime

      - name: Validate packaged OpenClaw usage age SLO gate
        run: npm run validate:packaged-usage-age-slo:reuse-artifact

      - name: Validate packaged OpenClaw alert-rate transition contract
        run: npm run validate:packaged-usage-alert-rate-e2e:reuse-artifact

      - name: Validate packaged OpenClaw parser resilience for non-zero-exit noisy probes
        run: npm run validate:packaged-usage-probe-noise-e2e:reuse-artifact

      - name: Validate packaged OpenClaw release gates (health + stats fallback + cache recovery)
        run: npm run validate:packaged-openclaw-release-gates:reuse-artifact --silent

      - name: Validate packaged OpenClaw usage stale-threshold recovery
        run: npm run validate:packaged-usage-recovery-e2e:reuse-artifact

      - name: Build unsigned DMG
        run: npm run package:dmg

      - name: Validate DMG checksum
        run: npm run validate:dmg-checksum

      - name: Validate DMG install + launcher dry-run schema
        run: npm run validate:dmg-install
