name: CI

on:
  push:
  pull_request:

jobs:
  node-tests:
    name: Node ${{ matrix.node-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            node-version: 20
          - os: ubuntu-latest
            node-version: 22
          - os: macos-latest
            node-version: 22
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install
        run: npm install

      - name: Validate package bin entries
        run: npm run validate:bin

      - name: Lint (if present)
        run: npm run lint --if-present

      - name: Unit tests
        run: npm run test:unit

      - name: Smoke: CLI help
        run: npm run smoke:help

      - name: Smoke: dry run
        run: npm run smoke:dry-run

      - name: Validate dry-run telemetry schema
        run: npm run validate:dry-run-schema

  macos-packaging-smoke:
    name: macOS packaging scaffold smoke
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install
        run: npm install

      - name: Build macOS app scaffold
        run: npm run package:macos

      - name: App scaffold dry-run
        run: ./dist/IdleWatch.app/Contents/MacOS/IdleWatch --dry-run

      - name: Validate packaged app dry-run telemetry schema
        run: npm run validate:packaged-dry-run-schema

      - name: Build unsigned DMG
        run: npm run package:dmg
